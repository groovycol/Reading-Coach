{% extends 'base.html' %}
{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.js"> </script>
<script src="https://code.jquery.com/jquery.js"></script>
    {% if admin.nameprefix.prefix == "Organization" %}
        <h1> {{admin.name}} Readers Report</h1>
    {% else %}
        <h1> {{admin.nameprefix.prefix}} {{admin.name}} Readers Report</h1>
    {% endif %}
        <input type="hidden" id="admin_id" value="{{admin.admin_id}}">
        <div class="admin-progress-chart"></div>
        <div id="barLegend" class="chart-legend"></div>
        <div id="canvas"></div>
        <button type="button" id="showbutton" onclick="location='/progress-view'" hidden>Return to All Students View</button>
        <br>
        <br>
        <form action="/send-sms-from-admin.json">
            <input type="text" style="height:100px;width:400px;font-size:12pt;" id="messagebox" placeholder="Keep up the great work!" hidden>
            <div>
                <input type="submit" id="submit" value="Send a Text Message to this Reader" hidden>
            </div>
        </form>
        <script>
            // Initialize some chart variables
            var canvas_tag = '<canvas id="barChart" width="1000" height="500"></canvas>'

            var options = { responsive: false, maintainAspectRatio: true};

            // initial chart display
            $.get("/admin-progress.json", {"admin_id": $("#admin_id").val() }, function (data) {

                // clear the canvas
                $("#barChart").remove()
                $("#canvas").append(canvas_tag)

                // initialize chart
                var ctx_bar = $("#barChart").get(0).getContext("2d");

                // draw chart
                var myBarChart = new Chart(ctx_bar).Bar(data,
                                                     options);

                // add a legend
                $('#barLegend').html(myBarChart.generateLegend());

                // event handler for clicking on a data bar in the chart
                $("#barChart").click( function(evt) {
                    var activePoints = myBarChart.getBarsAtEvent(evt);
                    var reader = activePoints[0].label;

                    // clear the canvas
                    $("#barChart").remove()
                    $("#canvas").append(canvas_tag)

                    // re-initialize chart
                    var ctx_bar = $("#barChart").get(0).getContext("2d");

                    //draw new chart
                    $.get("/admin-reader-detail.json", {"reader": reader}, function (data){
                        var myBarChart = new Chart(ctx_bar).Bar(data, options);

                        // add a chart legend
                        $('#barLegend').html(myBarChart.generateLegend());

                        // show button to return to all students view
                        $('#showbutton').show()

                        // show message box and submit button
                        $('#messagebox').show() 
                        $('#submit').show()

                        // messagebox submit event function
                        function send_message(evt) {
                            evt.preventDefault();
                            $.get("/send-sms-from-admin.json", {"reader": reader, "message_txt": $('#messagebox').val }, function (data){
                                     alert(data);
                                });
                        }
                        // event listener for messagebox 
                        $('#submit').on("submit", send_message);
                    })
                })
            });

        </script>
{% endblock %}